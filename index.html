<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repshare - Your Recipe Sharing Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for light mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Default background for main content */
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for theme changes */
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
        }
        .header-logo {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
        }

        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        body.dark-mode .card {
            background-color: #2d3748; /* Darker card background */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); /* Stronger shadow for contrast */
        }
        body.dark-mode .card:hover {
            transform: translateY(-2px); /* Subtle lift on hover */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        body.dark-mode .text-gray-800 {
            color: #e2e8f0; /* Light text for headings */
        }
        body.dark-mode .text-gray-700 {
            color: #cbd5e0; /* Lighter gray text */
        }
        body.dark-mode .text-gray-600 {
            color: #a0aec0; /* Even lighter gray text */
        }
        body.dark-mode .text-gray-500 {
            color: #718096; /* Lightest gray for subtle text */
        }
        body.dark-mode .text-gray-400 {
            color: #4a5568; /* Still visible but darker */
        }
        body.dark-mode .input-field {
            background-color: #4a5568; /* Dark input background */
            border-color: #2d3748; /* Darker border */
            color: #e2e8f0; /* Light text in input */
        }
        body.dark-mode .input-field:focus {
            border-color: #ef4444; /* Red focus remains */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4); /* Stronger shadow */
        }
        body.dark-mode header {
            background: linear-gradient(to right, #2d3748, #4a5568); /* Darker gradient for header */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .border-gray-100 {
            border-color: #4a5568; /* Darker border for separators */
        }
        body.dark-mode .bg-gray-100 { /* For profile user ID background */
            background-color: #4a5568;
        }
        body.dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark-mode .close-button {
            color: #cbd5e0;
        }
        body.dark-mode .close-button:hover,
        body.dark-mode .close-button:focus {
            color: #e2e8f0;
        }
        body.dark-mode .auth-background .card {
            background-color: rgba(45, 55, 72, 0.95); /* Darker transparent card */
            backdrop-filter: blur(8px); /* Slightly stronger blur */
        }
        body.dark-mode .auth-background h1 {
            color: #e2e8f0; /* Ensure headings are light in dark mode auth pages */
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.2s ease-in-out; /* Added transition for card hover */
        }
        /* Card hover effect */
        .card:hover {
            transform: translateY(-2px); /* Subtle lift on hover */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* More pronounced shadow */
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #ef4444; /* Red-500 */
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #dc2626; /* Red-600 */
            transform: translateY(-2px); /* Enhanced lift */
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4); /* Stronger shadow on hover */
        }
        .btn-secondary {
            background-color: #6b7280; /* Gray-500 */
            color: #fff;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Gray-600 */
            transform: translateY(-2px); /* Enhanced lift */
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.4); /* Stronger shadow on hover */
        }
        .btn-outline {
            border: 2px solid #ef4444;
            color: #ef4444;
            background-color: transparent;
        }
        .btn-outline:hover {
            background-color: #fef2f2; /* Red-50 */
            transform: translateY(-2px); /* Enhanced lift */
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.2); /* Stronger shadow on hover */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ef4444;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #ef4444; /* Red-500 */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        /* Styling for the background image on Login/Signup pages */
        .auth-background {
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 6rem);
            padding: 2rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url('assets/images/your-background-image.jpg'); /* Food-related placeholder */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed; /* Added for better background handling */
        }

        /* Overlay to darken image and improve text readability */
        .auth-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); /* Semi-transparent dark overlay */
            z-index: -1; /* Between image and content */
        }

        .auth-background .card {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white card */
            backdrop-filter: blur(5px); /* Subtle blur effect on the card */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* Stronger shadow for floating effect */
            position: relative; /* Ensure card stacks above image and overlay */
            z-index: 1; /* Place above image and overlay */
        }

        /* Header gradient for a polished look */
        header {
            background: linear-gradient(to right, #ffffff, #f0f4f8); /* Subtle white to light grey-blue gradient */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Lighter shadow */
        }
        body.dark-mode header {
            background: linear-gradient(to right, #2d3748, #4a5568); /* Darker gradient for header */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Recipe card load-in animation */
        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .recipe-card {
            opacity: 0; /* Start hidden */
            animation: fadeInSlideUp 0.6s ease-out forwards; /* Apply animation */
        }
        /* Staggered animation effect for recipe cards */
        .recipes-grid .recipe-card:nth-child(1) { animation-delay: 0.1s; }
        .recipes-grid .recipe-card:nth-child(2) { animation-delay: 0.2s; }
        .recipes-grid .recipe-card:nth-child(3) { animation-delay: 0.3s; }
        .recipes-grid .recipe-card:nth-child(4) { animation-delay: 0.4s; }
        .recipes-grid .recipe-card:nth-child(5) { animation-delay: 0.5s; }
        .recipes-grid .recipe-card:nth-child(6) { animation-delay: 0.6s; }
        /* Add more as needed for larger grids */

        /* Mobile Menu styles */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.98); /* Slightly transparent white */
            backdrop-filter: blur(8px);
            z-index: 1001; /* Above other content */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: translateX(100%); /* Start off-screen to the right */
            transition: transform 0.3s ease-out;
        }

        .mobile-menu.open {
            transform: translateX(0); /* Slide in */
        }

        body.dark-mode .mobile-menu {
            background-color: rgba(26, 32, 44, 0.98); /* Dark background for mobile menu */
        }

        .mobile-menu .close-button {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 2.5rem;
            color: #333;
        }
        body.dark-mode .mobile-menu .close-button {
            color: #e2e8f0;
        }

        /* Star rating styles */
        .star-rating {
            display: inline-block;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .star-rating .fa-star {
            color: #ccc; /* Default star color */
        }
        .star-rating .fa-star.active {
            color: #ffc107; /* Gold for active stars */
        }
        .star-rating .fa-star:hover,
        .star-rating .fa-star:hover ~ .fa-star {
            color: #ffc107; /* Highlight on hover */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="shadow-md py-4">
        <nav class="container flex justify-between items-center">
            <a href="#" id="home-link" class="text-3xl font-bold text-red-500 rounded-lg p-2 hover:bg-red-50 transition duration-200 header-logo">Repshare</a>

            <!-- Search Bar (visible on medium screens and up) -->
            <div class="relative flex items-center w-full max-w-md mx-4 md:flex hidden">
                <input type="search" id="search-input" placeholder="Search recipes..." class="input-field pl-10 pr-10">
                <i class="fas fa-search absolute left-3 text-gray-400"></i>
                <button id="clear-search-btn" class="absolute right-3 text-gray-500 hover:text-gray-700 hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Desktop Navigation Links -->
            <div class="hidden md:flex items-center space-x-4">
                <button id="add-recipe-nav-btn" class="btn btn-primary hidden">Add Recipe</button>
                <button id="profile-nav-btn" class="btn btn-secondary hidden">Profile</button>
                <button id="login-nav-btn" class="btn btn-outline">Login</button>
                <button id="signup-nav-btn" class="btn btn-primary">Sign Up</button>
                <button id="logout-btn" class="btn btn-outline hidden">Logout</button>
                <button id="theme-toggle-btn" class="btn btn-secondary text-lg px-3 py-2">
                    <i class="fas fa-moon" id="theme-icon"></i> <!-- Moon icon for dark mode -->
                </button>
            </div>

            <!-- Hamburger Menu Icon (visible on small screens) -->
            <div class="md:hidden flex items-center space-x-4">
                <button id="search-mobile-btn" class="btn btn-secondary text-lg px-3 py-2">
                    <i class="fas fa-search"></i>
                </button>
                <button id="hamburger-menu-btn" class="btn btn-secondary text-lg px-3 py-2">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="mobile-menu hidden">
        <button class="close-button" id="mobile-menu-close-btn">&times;</button>
        <div class="flex flex-col items-center space-y-6 text-2xl font-bold">
            <a href="#" id="home-link-mobile" class="text-gray-800 hover:text-red-500 transition duration-200">Home</a>
            <button id="add-recipe-nav-btn-mobile" class="btn btn-primary w-48">Add Recipe</button>
            <button id="profile-nav-btn-mobile" class="btn btn-secondary w-48">Profile</button>
            <button id="login-nav-btn-mobile" class="btn btn-outline w-48">Login</button>
            <button id="signup-nav-btn-mobile" class="btn btn-primary w-48">Sign Up</button>
            <button id="logout-btn-mobile" class="btn btn-outline w-48">Logout</button>
            <button id="theme-toggle-btn-mobile" class="btn btn-secondary text-lg px-3 py-2 w-48">
                <i class="fas fa-moon mr-2" id="theme-icon-mobile"></i> Toggle Theme
            </button>
        </div>
    </div>

    <main class="flex-grow">
        <section id="login-page" class="page hidden auth-background">
            <div class="card p-8 max-w-md mx-auto w-full">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Welcome Back!</h1>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-lg font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="login-email" required class="input-field">
                    </div>
                    <div>
                        <label for="login-password" class="block text-lg font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="login-password" required class="input-field">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                    <div id="login-message" class="mt-4 text-center text-sm font-medium"></div>
                    <p class="text-center text-gray-600 mt-4">Don't have an account? <a href="#" id="switch-to-signup" class="text-red-500 hover:underline">Sign Up</a></p>
                </form>
            </div>
        </section>

        <section id="signup-page" class="page hidden auth-background">
            <div class="card p-8 max-w-md mx-auto w-full">
                <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Join Repshare Today!</h1>
                <form id="signup-form" class="space-y-6">
                    <div>
                        <label for="signup-email" class="block text-lg font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="signup-email" required class="input-field">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-lg font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="signup-password" required class="input-field">
                        <p class="text-xs text-gray-500 mt-1">Must be at least 6 characters long.</p>
                    </div>
                    <div>
                        <label for="signup-confirm-password" class="block text-lg font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input type="password" id="signup-confirm-password" required class="input-field">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Sign Up</button>
                    <div id="signup-message" class="mt-4 text-center text-sm font-medium"></div>
                    <p class="text-center text-gray-600 mt-4">Already have an account? <a href="#" id="switch-to-login" class="text-red-500 hover:underline">Login</a></p>
                </form>
            </div>
        </section>

        <section id="home-page" class="page hidden container py-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Explore Delicious Recipes</h1>
            <!-- Mobile Search Bar (visible on small screens) -->
            <div class="relative flex items-center w-full max-w-md mx-auto mb-6 md:hidden">
                <input type="search" id="search-input-mobile" placeholder="Search recipes..." class="input-field pl-10 pr-10">
                <i class="fas fa-search absolute left-3 text-gray-400"></i>
                <button id="clear-search-btn-mobile" class="absolute right-3 text-gray-500 hover:text-gray-700 hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Category Filter (New Feature) -->
            <div class="mb-6 flex flex-wrap gap-2 justify-center">
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="All">All</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Breakfast">Breakfast</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Lunch">Lunch</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Dinner">Dinner</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Dessert">Dessert</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Snack">Snack</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Vegan">Vegan</button>
                <button class="btn btn-secondary px-4 py-2 text-sm category-filter-btn" data-category="Gluten-Free">Gluten-Free</button>
            </div>

            <div id="recipes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 recipes-grid">
                <!-- Initial loading message -->
                <div class="card p-6 flex flex-col items-center justify-center text-gray-500 recipe-card">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p>Loading recipes...</p>
                </div>
            </div>
            <div id="no-recipes-message" class="hidden text-center text-gray-500 mt-8">
                <p class="text-xl">No recipes found. Be the first to add one!</p>
            </div>
        </section>

        <section id="add-recipe-page" class="page hidden container py-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center" id="add-edit-recipe-title">Share Your Recipe</h1>
            <div class="card p-8 max-w-2xl mx-auto">
                <form id="add-recipe-form" class="space-y-6">
                    <div>
                        <label for="recipe-title" class="block text-lg font-medium text-gray-700 mb-2">Recipe Title</label>
                        <input type="text" id="recipe-title" name="title" required class="input-field">
                    </div>
                    <div>
                        <label for="recipe-description" class="block text-lg font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="recipe-description" name="description" rows="4" required class="input-field"></textarea>
                        <button type="button" id="generate-description-btn" class="mt-2 btn btn-outline text-sm">Generate Description (AI)</button>
                        <span id="description-loading" class="loading-spinner hidden"></span>
                    </div>
                    <div>
                        <label for="recipe-ingredients" class="block text-lg font-medium text-gray-700 mb-2">Ingredients (one per line)</label>
                        <textarea id="recipe-ingredients" name="ingredients" rows="6" required class="input-field"></textarea>
                    </div>
                    <div>
                        <label for="recipe-instructions" class="block text-lg font-medium text-gray-700 mb-2">Instructions (one step per line)</label>
                        <textarea id="recipe-instructions" name="instructions" rows="8" required class="input-field"></textarea>
                    </div>
                    <!-- New: Categories/Tags Input -->
                    <div>
                        <label for="recipe-categories" class="block text-lg font-medium text-gray-700 mb-2">Categories (comma-separated)</label>
                        <input type="text" id="recipe-categories" name="categories" class="input-field" placeholder="e.g., Breakfast, Vegan, Quick">
                    </div>
                    <div>
                        <label for="recipe-image-url" class="block text-lg font-medium text-gray-700 mb-2">Image URL (Optional)</label>
                        <input type="url" id="recipe-image-url" name="imageUrl" class="input-field" placeholder="e.g., https://placehold.co/600x400">
                    </div>
                    <button type="submit" class="btn btn-primary w-full" id="submit-recipe-btn">Add Recipe</button>
                    <div id="add-recipe-message" class="mt-4 text-center text-sm font-medium"></div>
                </form>
            </div>
        </section>

        <section id="recipe-detail-page" class="page hidden container py-8">
            <button id="back-to-home-btn" class="btn btn-secondary mb-6"><i class="fas fa-arrow-left mr-2"></i> Back to Recipes</button>
            <div id="recipe-detail-content" class="card p-8">
                <h1 id="detail-title" class="text-4xl font-extrabold text-gray-800 mb-4"></h1>
                <div class="flex items-center mb-4">
                    <img id="detail-author-avatar" src="https://placehold.co/40x40/cccccc/333333?text=User" alt="Author Avatar" class="w-10 h-10 rounded-full mr-3 object-cover">
                    <p id="detail-author" class="text-gray-600 text-lg"></p>
                </div>
                <img id="detail-image" src="" alt="Recipe Image" class="w-full h-96 object-cover rounded-lg mb-6 shadow-md">
                <p id="detail-description" class="text-gray-700 text-lg leading-relaxed mb-6"></p>

                <!-- New: Categories Display -->
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Categories:</h2>
                    <div id="detail-categories" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Ingredients</h2>
                        <!-- New: Ingredient Scaling -->
                        <div class="flex items-center mb-4">
                            <label for="servings-input" class="mr-2 text-gray-700">Servings:</label>
                            <input type="number" id="servings-input" value="1" min="1" class="w-20 input-field mr-2">
                            <button id="scale-ingredients-btn" class="btn btn-secondary text-sm">Scale</button>
                        </div>
                        <ul id="detail-ingredients" class="list-disc list-inside text-gray-700 space-y-2"></ul>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Instructions</h2>
                        <ol id="detail-instructions" class="list-decimal list-inside text-gray-700 space-y-2"></ol>
                    </div>
                </div>

                <div class="flex items-center justify-center space-x-6 mt-8">
                    <button id="like-btn" class="flex items-center text-gray-600 hover:text-red-500 transition duration-200">
                        <i class="far fa-heart text-2xl mr-2"></i>
                        <span id="likes-count" class="text-lg">0</span>
                    </button>
                    <button id="favorite-btn" class="flex items-center text-gray-600 hover:text-yellow-500 transition duration-200">
                        <i class="far fa-star text-2xl mr-2"></i>
                        <span id="favorites-count" class="text-lg">0</span>
                    </button>
                    <button id="save-btn" class="flex items-center text-gray-600 hover:text-blue-500 transition duration-200">
                        <i class="far fa-bookmark text-2xl mr-2"></i>
                        <span id="saves-count" class="text-lg">0</span>
                    </button>
                    <button id="share-btn" class="flex items-center text-gray-600 hover:text-green-500 transition duration-200">
                        <i class="fas fa-share-alt text-2xl mr-2"></i>
                        <span class="text-lg">Share</span>
                    </button>
                    <!-- New: Add to Meal Plan Button -->
                    <button id="add-to-meal-plan-btn" class="flex items-center text-gray-600 hover:text-purple-500 transition duration-200">
                        <i class="fas fa-calendar-alt text-2xl mr-2"></i>
                        <span class="text-lg">Meal Plan</span>
                    </button>
                    <!-- New: Print Recipe Button -->
                    <button id="print-recipe-btn" class="flex items-center text-gray-600 hover:text-blue-500 transition duration-200">
                        <i class="fas fa-print text-2xl mr-2"></i>
                        <span class="text-lg">Print</span>
                    </button>
                </div>

                <!-- New: Ratings and Reviews Section -->
                <div class="mt-12 border-t border-gray-200 pt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Ratings & Reviews (<span id="reviews-count">0</span>)</h2>
                    <div class="flex items-center mb-4">
                        <span class="text-3xl font-bold text-yellow-500 mr-2" id="average-rating">0.0</span>
                        <div class="star-rating text-3xl" id="display-stars">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-800 mb-3">Leave a Review</h3>
                    <form id="review-form" class="space-y-4">
                        <div>
                            <label class="block text-lg font-medium text-gray-700 mb-2">Your Rating:</label>
                            <div class="star-rating" id="user-rating-stars">
                                <i class="far fa-star cursor-pointer" data-rating="1"></i>
                                <i class="far fa-star cursor-pointer" data-rating="2"></i>
                                <i class="far fa-star cursor-pointer" data-rating="3"></i>
                                <i class="far fa-star cursor-pointer" data-rating="4"></i>
                                <i class="far fa-star cursor-pointer" data-rating="5"></i>
                            </div>
                            <input type="hidden" id="selected-rating" value="0">
                        </div>
                        <div>
                            <label for="review-text" class="block text-lg font-medium text-gray-700 mb-2">Your Review:</label>
                            <textarea id="review-text" rows="4" class="input-field" placeholder="Share your thoughts on this recipe..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                        <div id="review-message" class="mt-2 text-center text-sm font-medium"></div>
                    </form>

                    <div id="reviews-list" class="mt-8 space-y-6">
                        <!-- Reviews will be loaded here -->
                        <p class="text-gray-500 text-center">No reviews yet. Be the first!</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="profile-page" class="page hidden container py-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Your Profile</h1>
            <div class="card p-8 max-w-2xl mx-auto space-y-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Personal Details</h2>
                    <p class="text-gray-700 mb-2"><strong>User ID:</strong> <span id="profile-user-id" class="font-mono text-sm bg-gray-100 p-1 rounded"></span></p>
                    <!-- New: Profile Image Upload -->
                    <div class="flex items-center mb-4">
                        <img id="profile-avatar-display" src="https://placehold.co/80x80/cccccc/333333?text=Avatar" alt="Profile Avatar" class="w-20 h-20 rounded-full mr-4 object-cover">
                        <div>
                            <label for="profile-image-url" class="block text-lg font-medium text-gray-700 mb-2">Profile Image URL</label>
                            <input type="url" id="profile-image-url" class="input-field" placeholder="e.g., https://example.com/your-avatar.jpg">
                        </div>
                    </div>
                    <label for="profile-display-name" class="block text-lg font-medium text-gray-700 mb-2">Display Name</label>
                    <input type="text" id="profile-display-name" class="input-field">
                    <label for="profile-bio" class="block text-lg font-medium text-gray-700 mt-4 mb-2">Bio</label>
                    <textarea id="profile-bio" rows="3" class="input-field"></textarea>
                    <button id="update-profile-btn" class="mt-4 btn btn-primary">Update Profile</button>
                    <div id="profile-message" class="mt-4 text-center text-sm font-medium"></div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Added Recipes</h2>
                    <div id="profile-added-recipes" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">No recipes added yet.</p>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Liked Recipes</h2>
                    <div id="profile-liked-recipes" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">No recipes liked yet.</p>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Saved Recipes</h2>
                    <div id="profile-saved-recipes" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">No recipes saved yet.</p>
                    </div>
                </div>

                <!-- New: Your Meal Plan -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Meal Plan</h2>
                    <div id="profile-meal-plan" class="grid grid-cols-1 gap-4">
                        <p class="text-gray-500">No recipes in your meal plan yet.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="message-modal-close">&times;</span>
            <p id="modal-message" class="text-lg text-center"></p>
            <div class="flex justify-center mt-4">
                <button id="modal-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Ensure these imports are for Firebase SDK version 11.6.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import 'documentId' explicitly for querying by document ID
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, onSnapshot, query, where, arrayUnion, arrayRemove, setDoc, deleteDoc, FieldPath, documentId } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These variables are automatically provided by the Canvas environment.
        // DO NOT change their assignment. They ensure your app can connect to Firebase.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-repshare-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyB8z89BvKYPiyjRawukvWHlluUehK2DYWM",
        authDomain: "my-project-a64ba.firebaseapp.com",
        projectId: "my-project-a64ba",
        storageBucket: "my-project-a64ba.firebasestorage.app",
        messagingSenderId: "915041063505",
        appId: "1:915041063505:web:1f2717f4759af1bb879e70"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null; // Stores the Firebase User object
        let currentUserId = null; // Stores the Firebase User UID (string)
        let isAuthReady = false; // Flag to indicate if onAuthStateChanged has completed its initial check

        let allRecipes = []; // Store all recipes fetched from Firestore for client-side filtering
        let editingRecipeId = null; // Stores the ID of the recipe being edited, null otherwise
        let currentRecipeId = null; // Stores the ID of the currently viewed recipe
        let currentRecipeData = null; // Stores the full data of the currently viewed recipe

        let originalIngredients = []; // To store ingredients for scaling
        let initialRecipeIdFromHash = null; // To store recipe ID if provided in URL hash


        // --- UI Element References ---
        const pages = document.querySelectorAll('.page');
        const loginPage = document.getElementById('login-page');
        const signupPage = document.getElementById('signup-page');
        const homePage = document.getElementById('home-page');
        const addRecipePage = document.getElementById('add-recipe-page');
        const recipeDetailPage = document.getElementById('recipe-detail-page');
        const profilePage = document.getElementById('profile-page');

        const homeLink = document.getElementById('home-link');
        const addRecipeNavBtn = document.getElementById('add-recipe-nav-btn');
        const profileNavBtn = document.getElementById('profile-nav-btn');
        const loginNavBtn = document.getElementById('login-nav-btn');
        const signupNavBtn = document.getElementById('signup-nav-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');

        // Search bar elements
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const clearSearchBtnMobile = document.getElementById('clear-search-btn-mobile');
        const searchMobileBtn = document.getElementById('search-mobile-btn'); // For mobile search bar toggle

        // Mobile menu elements
        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuCloseBtn = document.getElementById('mobile-menu-close-btn');
        const homeLinkMobile = document.getElementById('home-link-mobile');
        const addRecipeNavBtnMobile = document.getElementById('add-recipe-nav-btn-mobile');
        const profileNavBtnMobile = document.getElementById('profile-nav-btn-mobile');
        const loginNavBtnMobile = document.getElementById('login-nav-btn-mobile');
        const signupNavBtnMobile = document.getElementById('signup-nav-btn-mobile');
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        const themeToggleBtnMobile = document = document.getElementById('theme-toggle-btn-mobile');
        const themeIconMobile = document.getElementById('theme-icon-mobile');

        // Category filter buttons
        const categoryFilterButtons = document.querySelectorAll('.category-filter-btn');
        let currentCategoryFilter = 'All'; // Default filter

        const recipesGrid = document.getElementById('recipes-grid');
        const noRecipesMessage = document.getElementById('no-recipes-message');

        const loginForm = document.getElementById('login-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessage = document.getElementById('login-message');
        const switchToSignupLink = document.getElementById('switch-to-signup');

        const signupForm = document.getElementById('signup-form');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
        const signupMessage = document.getElementById('signup-message');
        const switchToLoginLink = document.getElementById('switch-to-login');

        const addRecipeForm = document.getElementById('add-recipe-form');
        const addEditRecipeTitle = document.getElementById('add-edit-recipe-title'); // For "Add" or "Edit" title
        const submitRecipeBtn = document.getElementById('submit-recipe-btn'); // For "Add" or "Update" button
        const recipeTitleInput = document.getElementById('recipe-title');
        const recipeDescriptionInput = document.getElementById('recipe-description');
        const recipeIngredientsInput = document.getElementById('recipe-ingredients');
        const recipeInstructionsInput = document.getElementById('recipe-instructions');
        const recipeCategoriesInput = document.getElementById('recipe-categories'); // New
        const recipeImageUrlInput = document.getElementById('recipe-image-url');
        const addRecipeMessage = document.getElementById('add-recipe-message');
        const generateDescriptionBtn = document.getElementById('generate-description-btn');
        const descriptionLoadingSpinner = document.getElementById('description-loading');

        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const detailTitle = document.getElementById('detail-title');
        const detailAuthor = document.getElementById('detail-author');
        const detailAuthorAvatar = document.getElementById('detail-author-avatar'); // New
        const detailImage = document.getElementById('detail-image');
        const detailDescription = document.getElementById('detail-description');
        const detailCategories = document.getElementById('detail-categories'); // New
        const servingsInput = document.getElementById('servings-input'); // New
        const scaleIngredientsBtn = document.getElementById('scale-ingredients-btn'); // New
        const detailIngredients = document.getElementById('detail-ingredients');
        const detailInstructions = document.getElementById('detail-instructions');
        const likeBtn = document.getElementById('like-btn');
        const favoriteBtn = document.getElementById('favorite-btn');
        const saveBtn = document.getElementById('save-btn');
        const shareBtn = document.getElementById('share-btn');
        const addToMealPlanBtn = document.getElementById('add-to-meal-plan-btn'); // New
        const printRecipeBtn = document.getElementById('print-recipe-btn'); // New
        const likesCountSpan = document.getElementById('likes-count');
        const favoritesCountSpan = document.getElementById('favorites-count');
        const savesCountSpan = document.getElementById('saves-count');

        // Review elements
        const averageRatingSpan = document.getElementById('average-rating'); // New
        const displayStarsContainer = document.getElementById('display-stars'); // New
        const reviewsCountSpan = document.getElementById('reviews-count'); // New
        const reviewForm = document.getElementById('review-form'); // New
        const userRatingStars = document.getElementById('user-rating-stars'); // New
        const selectedRatingInput = document.getElementById('selected-rating'); // New
        const reviewTextInput = document.getElementById('review-text'); // New
        const reviewMessage = document.getElementById('review-message'); // New
        const reviewsList = document.getElementById('reviews-list'); // New

        const profileUserIdSpan = document.getElementById('profile-user-id');
        const profileAvatarDisplay = document.getElementById('profile-avatar-display'); // New
        const profileImageUrlInput = document.getElementById('profile-image-url'); // New
        const profileDisplayNameInput = document.getElementById('profile-display-name');
        const profileBioInput = document.getElementById('profile-bio');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const profileMessage = document.getElementById('profile-message');
        const profileAddedRecipes = document.getElementById('profile-added-recipes');
        const profileLikedRecipes = document.getElementById('profile-liked-recipes');
        const profileSavedRecipes = document.getElementById('profile-saved-recipes');
        const profileMealPlan = document.getElementById('profile-meal-plan'); // New

        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const messageModalCloseBtn = document.getElementById('message-modal-close');
        const modalOkBtn = document.getElementById('modal-ok-btn');

        // --- Helper Functions (Defined first to ensure availability) ---

        /**
         * Displays a modal message to the user.
         * @param {string} message The message to display.
         * @param {function} [onOk] Optional callback function when OK is clicked.
         */
        function showModalMessage(message, onOk = null) {
            modalMessage.textContent = message;
            modalMessage.classList.remove('text-green-600', 'text-red-600'); // Reset color
            messageModal.style.display = 'flex';
            modalOkBtn.onclick = () => {
                messageModal.style.display = 'none';
                if (onOk) onOk();
            };
            messageModalCloseBtn.onclick = () => {
                messageModal.style.display = 'none';
                if (onOk) onOk(); // Also call onOk if closed via X
            };
        }

        /**
         * Shows a specific page and hides others.
         * @param {HTMLElement} pageToShow The page element to display.
         */
        function showPage(pageToShow) {
            console.log(`Attempting to show page: ${pageToShow ? pageToShow.id : 'null'}`);
            pages.forEach(page => page.classList.add('hidden'));
            if (pageToShow) {
                pageToShow.classList.remove('hidden');
            }
            // Close mobile menu if open
            mobileMenu.classList.remove('open');
            document.body.style.overflow = ''; // Re-enable scrolling

            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top

            updateNavVisibility(!!currentUser); // Update navigation buttons visibility
            if (pageToShow !== addRecipePage) {
                resetAddEditForm(); // Reset add/edit form when navigating away
            }
        }

        /**
         * Resets the add/edit recipe form.
         */
        function resetAddEditForm() {
            addRecipeForm.reset();
            editingRecipeId = null;
            addEditRecipeTitle.textContent = 'Share Your Recipe';
            submitRecipeBtn.textContent = 'Add Recipe';
            addRecipeMessage.textContent = '';
            recipeDescriptionInput.value = '';
        }

        /**
         * Updates navigation buttons visibility based on authentication status.
         * @param {boolean} isAuthenticated True if a user is authenticated, false otherwise.
         */
        function updateNavVisibility(isAuthenticated) {
            const loggedInElements = [addRecipeNavBtn, profileNavBtn, logoutBtn, addRecipeNavBtnMobile, profileNavBtnMobile, logoutBtnMobile];
            const loggedOutElements = [loginNavBtn, signupNavBtn, loginNavBtnMobile, signupNavBtnMobile];

            loggedInElements.forEach(el => el.classList.toggle('hidden', !isAuthenticated));
            loggedOutElements.forEach(el => el.classList.toggle('hidden', isAuthenticated));
        }

        /**
         * Generates a placeholder image URL.
         * @param {string} text The text to display on the image.
         * @returns {string} The placeholder image URL.
         */
        function getPlaceholderImage(text) {
            const width = 600;
            const height = 400;
            const bgColor = 'cccccc';
            const textColor = '333333';
            return `https://placehold.co/${width}x${height}/${bgColor}/${textColor}?text=${encodeURIComponent(text)}`;
        }

        /**
         * Renders a single recipe card for display on the home page or profile.
         * @param {Object} recipe The recipe data.
         * @param {boolean} showEditDelete If true, adds edit/delete buttons (for profile page).
         * @returns {HTMLElement} The recipe card element.
         */
        function createRecipeCard(recipe, showEditDelete = false) {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col cursor-pointer recipe-card';
            card.setAttribute('data-id', recipe.id);

            const img = document.createElement('img');
            img.src = recipe.imageUrl || getPlaceholderImage(recipe.title);
            img.alt = recipe.title;
            img.className = 'w-full h-48 object-cover rounded-md mb-4';
            img.onerror = () => { img.src = getPlaceholderImage(recipe.title); };

            const title = document.createElement('h3');
            title.className = 'text-xl font-semibold text-gray-800 mb-2';
            title.textContent = recipe.title;

            const description = document.createElement('p');
            description.className = 'text-gray-600 text-sm flex-grow mb-4 line-clamp-3';
            description.textContent = recipe.description;

            const authorDiv = document.createElement('div');
            authorDiv.className = 'flex items-center text-gray-500 text-xs mb-2';
            const authorAvatar = document.createElement('img');
            authorAvatar.src = recipe.authorAvatarUrl || getPlaceholderImage('User');
            authorAvatar.alt = 'Author Avatar';
            authorAvatar.className = 'w-6 h-6 rounded-full mr-2 object-cover';
            authorAvatar.onerror = () => { authorAvatar.src = getPlaceholderImage('User'); };
            const authorName = document.createElement('span');
            authorName.textContent = `By: ${recipe.userName || 'Anonymous'}`;
            authorDiv.appendChild(authorAvatar);
            authorDiv.appendChild(authorName);

            const categoriesDiv = document.createElement('div');
            categoriesDiv.className = 'flex flex-wrap gap-1 text-xs mb-2';
            if (recipe.categories && recipe.categories.length > 0) {
                recipe.categories.forEach(cat => {
                    const span = document.createElement('span');
                    span.className = 'bg-gray-200 text-gray-700 px-2 py-1 rounded-full';
                    span.textContent = cat;
                    categoriesDiv.appendChild(span);
                });
            }

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex items-center justify-between mt-auto pt-4 border-t border-gray-100';

            const interactionIcons = document.createElement('div');
            interactionIcons.className = 'flex items-center space-x-4';

            const likes = document.createElement('span');
            likes.className = 'flex items-center text-gray-600 text-sm';
            likes.innerHTML = `<i class="fas fa-heart mr-1 text-red-500"></i> ${recipe.likesCount || 0}`;

            const favorites = document.createElement('span');
            favorites.className = 'flex items-center text-gray-600 text-sm';
            favorites.innerHTML = `<i class="fas fa-star mr-1 text-yellow-500"></i> ${recipe.favoritesCount || 0}`;

            const avgRating = document.createElement('span');
            avgRating.className = 'flex items-center text-gray-600 text-sm';
            const starIcon = document.createElement('i');
            starIcon.className = 'fas fa-star mr-1 text-yellow-500';
            const ratingText = document.createElement('span');
            ratingText.textContent = (recipe.averageRating ? recipe.averageRating.toFixed(1) : '0.0');
            avgRating.appendChild(starIcon);
            avgRating.appendChild(ratingText);

            interactionIcons.appendChild(likes);
            interactionIcons.appendChild(favorites);
            interactionIcons.appendChild(avgRating);
            actionsDiv.appendChild(interactionIcons);

            card.appendChild(img);
            card.appendChild(title);
            card.appendChild(description);
            card.appendChild(authorDiv);
            card.appendChild(categoriesDiv);
            card.appendChild(actionsDiv);

            card.addEventListener('click', () => {
                console.log("Recipe card clicked. Recipe ID:", recipe.id, "Current User ID (from global):", currentUserId);
                viewRecipeDetail(recipe.id);
            });

            if (showEditDelete) {
                const editDeleteContainer = document.createElement('div');
                editDeleteContainer.className = 'flex space-x-2 mt-4';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-outline text-sm px-3 py-1';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    loadRecipeForEdit(recipe.id);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-secondary text-sm px-3 py-1 bg-red-500 hover:bg-red-600';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    showModalMessage("Are you sure you want to delete this recipe?", async () => {
                        await deleteRecipe(recipe.id);
                    });
                });
                editDeleteContainer.appendChild(editBtn);
                editDeleteContainer.appendChild(deleteBtn);
                card.appendChild(editDeleteContainer);
            }
            return card;
        }

        /**
         * Renders a list of recipes into a given container.
         * @param {HTMLElement} container The container element to render recipes into.
         * @param {Array<Object>} recipes The array of recipe data.
         * @param {boolean} showEditDelete If true, adds edit/delete buttons (for profile page).
         */
        function renderRecipes(container, recipes, showEditDelete = false) {
            container.innerHTML = ''; // Clear existing content
            if (recipes.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No recipes found.</p>`;
                if (container === recipesGrid) { // Only show global message for main grid
                   noRecipesMessage.classList.remove('hidden');
                }
                return;
            }
            noRecipesMessage.classList.add('hidden'); // Hide if recipes are found
            recipes.forEach(recipe => {
                container.appendChild(createRecipeCard(recipe, showEditDelete));
            });
        }

        /**
         * Renders meal plan items into a given container.
         * @param {HTMLElement} container The container element.
         * @param {Array<Object>} mealPlanItems The array of meal plan entries.
         */
        function renderMealPlanItems(container, mealPlanItems) {
            container.innerHTML = '';
            if (mealPlanItems.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No recipes in your meal plan yet.</p>`;
                return;
            }
            mealPlanItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'card p-4 flex items-center justify-between';
                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        <img src="${item.imageUrl || getPlaceholderImage(item.title)}" alt="${item.title}" class="w-16 h-16 object-cover rounded-md mr-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${item.title}</h3>
                            <p class="text-gray-600 text-sm">Added: ${new Date(item.timestamp).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary text-sm remove-meal-plan-btn" data-id="${item.mealPlanEntryId}">Remove</button>
                `;
                container.appendChild(itemDiv);

                itemDiv.querySelector('.remove-meal-plan-btn').addEventListener('click', () => removeMealPlanItem(item.mealPlanEntryId));
            });
        }

        /**
         * Removes a recipe from the user's meal plan.
         * @param {string} mealPlanEntryId The ID of the meal plan document to remove.
         */
        async function removeMealPlanItem(mealPlanEntryId) {
            if (!currentUserId) {
                showModalMessage("Please sign in to manage your meal plan.", null);
                return;
            }
            try {
                // Path for meal plan items remains in a subcollection of the user document
                const mealPlanDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'mealPlans', mealPlanEntryId);
                await deleteDoc(mealPlanDocRef);
                showModalMessage("Recipe removed from meal plan.", null);
            } catch (error) {
                console.error("Error removing from meal plan:", error);
                showModalMessage("Failed to remove recipe from meal plan.", null);
            }
        }
        
        /**
         * Sets the visual display of stars based on a rating.
         * @param {HTMLElement} container The div containing the star icons.
         * @param {number} rating The rating (0-5).
         */
        function setStarRatingDisplay(container, rating) {
            const stars = container.querySelectorAll('.fa-star');
            stars.forEach((star, index) => {
                if (index < Math.floor(rating)) {
                    star.classList.add('fas', 'active');
                    star.classList.remove('far');
                } else if (index === Math.floor(rating) && rating % 1 !== 0) {
                    star.classList.add('fas', 'active');
                    star.classList.remove('far');
                } else {
                    star.classList.add('far');
                    star.classList.remove('fas', 'active');
                }
            });
        }

        /**
         * Resets star selection to empty.
         * @param {HTMLElement} container The div containing the star icons.
         */
        function resetStarSelection(container) {
            const stars = container.querySelectorAll('.fa-star');
            stars.forEach(star => {
                star.classList.remove('fas', 'active');
                star.classList.add('far');
            });
        }

        /**
         * Renders ingredients to the detail page.
         * @param {Array<string>} ingredients The array of ingredient strings.
         */
        function renderIngredients(ingredients) {
            detailIngredients.innerHTML = '';
            ingredients.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                detailIngredients.appendChild(li);
            });
        }

        /**
         * Updates the interaction button states (like, favorite, save) for the current recipe.
         * @param {string} recipeId The ID of the recipe being viewed.
         */
        async function updateInteractionButtonStates(recipeId) {
            if (!currentUserId) {
                // If no user is logged in, ensure buttons are reset to 'far' (outline)
                likeBtn.querySelector('i').classList.replace('fas', 'far');
                favoriteBtn.querySelector('i').classList.replace('fas', 'far');
                saveBtn.querySelector('i').classList.replace('fas', 'far');
                return;
            }

            try {
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userProfileSnap = await getDoc(userProfileDocRef);
                if (userProfileSnap.exists()) {
                    const profileData = userProfileSnap.data();
                    
                    // Check liked status
                    if (profileData.likedRecipes && profileData.likedRecipes.includes(recipeId)) {
                        likeBtn.querySelector('i').classList.replace('far', 'fas');
                        likeBtn.classList.add('text-red-500', 'font-bold');
                    } else {
                        likeBtn.querySelector('i').classList.replace('fas', 'far');
                        likeBtn.classList.remove('text-red-500', 'font-bold');
                    }
                    
                    // Check favorited status
                    if (profileData.favoritedRecipes && profileData.favoritedRecipes.includes(recipeId)) {
                        favoriteBtn.querySelector('i').classList.replace('far', 'fas');
                        favoriteBtn.classList.add('text-yellow-500', 'font-bold');
                    } else {
                        favoriteBtn.querySelector('i').classList.replace('fas', 'far');
                        favoriteBtn.classList.remove('text-yellow-500', 'font-bold');
                    }

                    // Check saved status
                    if (profileData.savedRecipes && profileData.savedRecipes.includes(recipeId)) {
                        saveBtn.querySelector('i').classList.replace('far', 'fas');
                        saveBtn.classList.add('text-blue-500', 'font-bold');
                    } else {
                        saveBtn.querySelector('i').classList.replace('fas', 'far');
                        saveBtn.classList.remove('text-blue-500', 'font-bold');
                    }

                }
            } catch (error) {
                console.error("Error updating interaction button states:", error);
            }
        }
        
        /**
         * Calculates and updates the average rating for a recipe.
         * @param {string} recipeId The ID of the recipe.
         */
        async function calculateAverageRating(recipeId) {
            try {
                const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/recipes/${recipeId}/reviews`);
                const querySnapshot = await getDocs(reviewsCollectionRef);
                let totalRating = 0;
                let numReviews = 0;

                querySnapshot.forEach(doc => {
                    totalRating += doc.data().rating;
                    numReviews++;
                });

                const averageRating = numReviews > 0 ? totalRating / numReviews : 0;

                // Update the recipe document with new average rating and review count
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, recipeId);
                await updateDoc(recipeDocRef, {
                    averageRating: parseFloat(averageRating.toFixed(1)), // Store as number, fixed to 1 decimal
                    numReviews: numReviews
                });
                console.log(`Updated recipe ${recipeId}: Avg Rating = ${averageRating.toFixed(1)}, Reviews = ${numReviews}`);
            } catch (error) {
                console.error("Error calculating average rating:", error);
            }
        }

        /**
         * Sets up a real-time listener for reviews of a specific recipe.
         * @param {string} recipeId The ID of the recipe.
         */
        function listenToReviews(recipeId) {
            const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/recipes/${recipeId}/reviews`);
            onSnapshot(reviewsCollectionRef, (snapshot) => {
                reviewsList.innerHTML = ''; // Clear existing reviews
                if (snapshot.empty) {
                    reviewsList.innerHTML = `<p class="text-gray-500 text-center">No reviews yet. Be the first!</p>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const review = doc.data();
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = 'border-b border-gray-100 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0';
                    reviewDiv.innerHTML = `
                        <div class="flex items-center mb-2">
                            <img src="${review.userAvatarUrl || getPlaceholderImage('User')}" alt="${review.userName}" class="w-8 h-8 rounded-full mr-3 object-cover">
                            <div>
                                <p class="font-semibold text-gray-800">${review.userName}</p>
                                <div class="star-rating text-sm" data-rating="${review.rating}">
                                    ${Array(5).fill().map((_, i) => `<i class="fas fa-star ${i < review.rating ? 'active' : ''}"></i>`).join('')}
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-700 text-sm">${review.reviewText}</p>
                        <p class="text-gray-500 text-xs mt-1">${new Date(review.timestamp).toLocaleDateString()}</p>
                    `;
                    reviewsList.appendChild(reviewDiv);
                });
            }, (error) => {
                console.error("Error fetching reviews:", error);
                reviewsList.innerHTML = `<p class="text-red-500 text-center">Failed to load reviews.</p>`;
            });
        }


        // --- Firebase Authentication Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentUserId = user.uid;
                console.log("User logged in:", currentUserId);
                updateNavVisibility(true);

                // Fetch or create user profile in Firestore
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userProfileDocSnap = await getDoc(userProfileDocRef);

                if (!userProfileDocSnap.exists()) {
                    // Create a new user profile if it doesn't exist
                    await setDoc(userProfileDocRef, {
                        displayName: `User_${currentUserId.substring(0, 6)}`,
                        email: user.email || 'N/A',
                        bio: 'A passionate home cook.',
                        profileImageUrl: getPlaceholderImage('Avatar'), // Default avatar
                        likedRecipes: [],
                        favoritedRecipes: [],
                        // Renamed 'savedRecipes' to 'bookmarkedRecipes' to avoid conflict if any in future and for clarity
                        savedRecipes: [], // Keep 'savedRecipes' as per current code expectation
                        createdAt: new Date().toISOString()
                    });
                    console.log("New user profile created.");
                } else {
                    console.log("Existing user profile loaded.");
                }

                isAuthReady = true; // Auth state is ready
                listenToRecipes(); // Call listen to recipes whenever auth state changes to ensure up-to-date data based on permissions
                listenToUserProfile(); // Start listening to user profile changes and display user-specific data

                // Handle deep linking for recipes
                if (initialRecipeIdFromHash) {
                    viewRecipeDetail(initialRecipeIdFromHash);
                    initialRecipeIdFromHash = null; // Clear after use
                } else {
                    showPage(homePage); // Default to home page
                }

            } else {
                console.log("No user signed in.");
                currentUser = null;
                currentUserId = null;
                updateNavVisibility(false);

                // Clear user-specific content areas when logged out
                profileAddedRecipes.innerHTML = `<p class="text-gray-500">Please sign in to see your recipes.</p>`;
                profileLikedRecipes.innerHTML = `<p class="text-gray-500">Please sign in to see your liked recipes.</p>`;
                profileSavedRecipes.innerHTML = `<p class="text-gray-500">Please sign in to see your saved recipes.</p>`;
                profileMealPlan.innerHTML = `<p class="text-gray-500">Please sign in to see your meal plan.</p>`;

                isAuthReady = true; // Auth state is ready even if unauthenticated
                
                // Attempt anonymous sign-in only if no other auth method is used and no user is signed in
                if (initialAuthToken) { // If running in Canvas, try to use the provided token
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token for initial access.");
                    } catch (error) {
                        console.error("Error during custom token sign-in:", error);
                        // Fallback to anonymous if custom token fails
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously as fallback.");
                        } catch (anonError) {
                            console.error("Error during anonymous fallback sign-in:", anonError);
                            // Make sure Anonymous Auth is enabled in Firebase Console -> Authentication -> Sign-in method
                        }
                    }
                } else { // If not in Canvas (e.g., local development), just try anonymous
                    try {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously for initial access (outside Canvas).");
                    } catch (error) {
                        console.error("Error during anonymous sign-in:", error);
                        // Make sure Anonymous Auth is enabled in Firebase Console -> Authentication -> Sign-in method
                    }
                }
                listenToRecipes(); // Still load public recipes when unauthenticated/anonymous
                showPage(homePage); // Default to home page for public view
            }
        });

        // --- Recipe Detail Functionality ---
        /**
         * Displays the detail page for a specific recipe.
         * @param {string} recipeId The ID of the recipe to display.
         */
        async function viewRecipeDetail(recipeId) {
            console.log("viewRecipeDetail entered. Passed recipeId:", recipeId, "Global currentUserId:", currentUserId);

            // Temporarily skip login check for easier debugging of recipe detail page if needed,
            // but for production, keep this enabled.
            // if (!currentUserId) {
            //     showModalMessage("Please log in or sign up to view full recipe details and interact with them.", () => {
            //         showPage(loginPage);
            //     });
            //     return;
            // }
            if (!recipeId) {
                console.error("viewRecipeDetail called without a recipeId.");
                showModalMessage("Could not load recipe details. Please try selecting a recipe again.", () => showPage(homePage));
                return;
            }

            currentRecipeId = recipeId; // Set the global variable for the current recipe
            console.log("Global currentRecipeId set to:", currentRecipeId);

            showPage(recipeDetailPage);
            // Reset detail page content before loading new data
            detailTitle.textContent = 'Loading...';
            detailAuthor.textContent = '';
            detailAuthorAvatar.src = getPlaceholderImage('User');
            detailImage.src = '';
            detailDescription.textContent = '';
            detailCategories.innerHTML = '';
            servingsInput.value = '1';
            detailIngredients.innerHTML = '';
            detailInstructions.innerHTML = '';
            likesCountSpan.textContent = '0';
            favoritesCountSpan.textContent = '0';
            savesCountSpan.textContent = '0';
            averageRatingSpan.textContent = '0.0';
            reviewsCountSpan.textContent = '0';
            reviewsList.innerHTML = `<p class="text-gray-500 text-center">No reviews yet. Be the first!</p>`;
            selectedRatingInput.value = '0';
            reviewTextInput.value = '';
            reviewMessage.textContent = '';
            resetStarSelection(userRatingStars);
            resetStarSelection(displayStarsContainer);

            // Reset interaction button styles
            likeBtn.classList.remove('text-red-500', 'font-bold');
            likeBtn.querySelector('i').classList.replace('fas', 'far');
            favoriteBtn.classList.remove('text-yellow-500', 'font-bold');
            favoriteBtn.querySelector('i').classList.replace('fas', 'far');
            saveBtn.classList.remove('text-blue-500', 'font-bold');
            saveBtn.querySelector('i').classList.replace('fas', 'far');

            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, currentRecipeId);
                console.log("Attempting to fetch recipe from path:", `artifacts/${appId}/public/data/recipes/${currentRecipeId}`);
                const recipeDocSnap = await getDoc(recipeDocRef);

                if (recipeDocSnap.exists()) {
                    console.log("Recipe document found:", recipeDocSnap.data());
                    currentRecipeData = { id: recipeDocSnap.id, ...recipeDocSnap.data() }; // Store full recipe data including ID
                    detailTitle.textContent = currentRecipeData.title;
                    detailAuthor.textContent = `By: ${currentRecipeData.userName || 'Anonymous'}`;
                    detailAuthorAvatar.src = currentRecipeData.authorAvatarUrl || getPlaceholderImage('User');
                    detailAuthorAvatar.onerror = () => { detailAuthorAvatar.src = getPlaceholderImage('User'); };
                    detailImage.src = currentRecipeData.imageUrl || getPlaceholderImage(currentRecipeData.title);
                    detailImage.onerror = () => { detailImage.src = getPlaceholderImage(currentRecipeData.title); };
                    detailDescription.textContent = currentRecipeData.description;

                    if (currentRecipeData.categories && currentRecipeData.categories.length > 0) {
                        detailCategories.innerHTML = '';
                        currentRecipeData.categories.forEach(cat => {
                            const span = document.createElement('span');
                            span.className = 'bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-sm';
                            span.textContent = cat;
                            detailCategories.appendChild(span);
                        });
                    } else {
                        detailCategories.innerHTML = `<p class="text-gray-500 text-sm">No categories specified.</p>`;
                    }

                    // Handle ingredients: ensure it's an array for consistency
                    originalIngredients = Array.isArray(currentRecipeData.ingredients) 
                        ? currentRecipeData.ingredients.map(item => item.trim()).filter(item => item !== '')
                        : (currentRecipeData.ingredients || '').split('\n').map(item => item.trim()).filter(item => item !== '');
                    renderIngredients(originalIngredients); // Render initial ingredients

                    detailInstructions.innerHTML = ''; // Clear previous
                    // Handle instructions: ensure it's an array for consistency
                    const instructionsArray = Array.isArray(currentRecipeData.instructions)
                        ? currentRecipeData.instructions.map(item => item.trim()).filter(item => item !== '')
                        : (currentRecipeData.instructions || '').split('\n').map(item => item.trim()).filter(item => item !== '');
                    instructionsArray.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        detailInstructions.appendChild(li);
                    });

                    likesCountSpan.textContent = currentRecipeData.likesCount || 0;
                    favoritesCountSpan.textContent = currentRecipeData.favoritesCount || 0;
                    savesCountSpan.textContent = currentRecipeData.savesCount || 0;
                    averageRatingSpan.textContent = (currentRecipeData.averageRating ? currentRecipeData.averageRating.toFixed(1) : '0.0');
                    reviewsCountSpan.textContent = currentRecipeData.numReviews || 0;
                    setStarRatingDisplay(displayStarsContainer, currentRecipeData.averageRating || 0);

                    // Update UI based on user's interaction status
                    await updateInteractionButtonStates(currentRecipeId); // Await this to ensure it finishes
                    listenToReviews(currentRecipeId); // Start listening to reviews for this recipe
                } else {
                    console.warn("Recipe document does not exist for ID:", currentRecipeId);
                    showModalMessage("Recipe not found.", () => showPage(homePage));
                }
            } catch (error) {
                console.error("Error fetching recipe details:", error);
                // More detailed error message for debugging
                showModalMessage(`Failed to load recipe details. Error: ${error.message}. Please check console for details and Firestore security rules.`, () => showPage(homePage));
            }
        }


        // --- Firestore Listeners ---

        /**
         * Sets up a real-time listener for all recipes.
         * Fetches all recipes and stores them in `allRecipes` for client-side filtering.
         * Then calls `filterAndRenderRecipes` to display them.
         */
        function listenToRecipes() {
            console.log("listenToRecipes called.");
            const recipesCollectionRef = collection(db, `artifacts/${appId}/public/data/recipes`);
            onSnapshot(recipesCollectionRef, (snapshot) => {
                console.log("onSnapshot for recipes fired. Snapshot empty:", snapshot.empty, "Snapshot size:", snapshot.size);
                allRecipes = []; // Clear previous data
                snapshot.forEach(doc => {
                    allRecipes.push({ id: doc.id, ...doc.data() });
                });
                console.log("Recipes loaded into allRecipes:", allRecipes.length, "recipes.");
                // Sort by timestamp if available, otherwise by title
                allRecipes.sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || '') || (a.title || '').localeCompare(b.title || ''));

                // Re-render recipes based on current search term and category filter
                filterAndRenderRecipes(); // No arguments needed, uses global search/filter states
            }, (error) => {
                console.error("Error fetching recipes in listenToRecipes:", error);
                // Display a user-friendly message, but avoid blocking the app with a modal on every error
                recipesGrid.innerHTML = `<div class="card p-6 flex flex-col items-center justify-center text-gray-500 recipe-card">
                    <p class="text-xl text-red-500">Failed to load recipes. Check console for details (e.g., Firestore Security Rules).</p>
                </div>`;
            });
        }

        /**
         * Filters the `allRecipes` array based on a search term and category and renders them.
         */
        function filterAndRenderRecipes() {
            const searchTerm = (searchInput.value || searchInputMobile.value).toLowerCase().trim();
            let filteredRecipes = allRecipes.filter(recipe =>
                (recipe.title || '').toLowerCase().includes(searchTerm) ||
                (recipe.description || '').toLowerCase().includes(searchTerm) ||
                (Array.isArray(recipe.ingredients) && recipe.ingredients.some(ing => (ing || '').toLowerCase().includes(searchTerm)))
                // If ingredients are stored as a single string, adjust this:
                // (typeof recipe.ingredients === 'string' && recipe.ingredients.toLowerCase().includes(searchTerm))
            );

            if (currentCategoryFilter !== 'All') {
                filteredRecipes = filteredRecipes.filter(recipe =>
                    Array.isArray(recipe.categories) && recipe.categories.some(cat => (cat || '').toLowerCase() === currentCategoryFilter.toLowerCase())
                );
            }
            renderRecipes(recipesGrid, filteredRecipes);
        }


        /**
         * Sets up a real-time listener for the current user's profile data and associated recipes.
         */
        function listenToUserProfile() {
            if (!currentUserId || !isAuthReady) {
                console.warn("Auth not ready or no current user ID for profile listener.");
                return;
            }
            // User profile document is now directly at artifacts/{appId}/users/{userId}
            const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
            onSnapshot(userProfileDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    profileUserIdSpan.textContent = currentUserId;
                    profileDisplayNameInput.value = userData.displayName || '';
                    profileBioInput.value = userData.bio || '';
                    profileImageUrlInput.value = userData.profileImageUrl || '';
                    profileAvatarDisplay.src = userData.profileImageUrl || getPlaceholderImage('Avatar');
                    profileAvatarDisplay.onerror = () => { profileAvatarDisplay.src = getPlaceholderImage('Avatar'); };

                    // Fetch and display user's added recipes
                    const addedRecipesQuery = query(collection(db, `artifacts/${appId}/public/data/recipes`), where("userId", "==", currentUserId));
                    const addedRecipesSnapshot = await getDocs(addedRecipesQuery);
                    const addedRecipes = addedRecipesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderRecipes(profileAddedRecipes, addedRecipes, true); // Show edit/delete for own recipes

                    // Fetch and display user's liked recipes
                    if (userData.likedRecipes && userData.likedRecipes.length > 0) {
                        // Corrected usage of documentId() function
                        const likedRecipesQuery = query(collection(db, `artifacts/${appId}/public/data/recipes`), where(documentId(), 'in', userData.likedRecipes));
                        const likedRecipesSnapshot = await getDocs(likedRecipesQuery);
                        const likedRecipes = likedRecipesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderRecipes(profileLikedRecipes, likedRecipes);
                    } else {
                        profileLikedRecipes.innerHTML = `<p class="text-gray-500">No recipes liked yet.</p>`;
                    }

                    // Fetch and display user's saved recipes
                    if (userData.savedRecipes && userData.savedRecipes.length > 0) {
                        // Corrected usage of documentId() function
                        const savedRecipesQuery = query(collection(db, `artifacts/${appId}/public/data/recipes`), where(documentId(), 'in', userData.savedRecipes));
                        const savedRecipesSnapshot = await getDocs(savedRecipesQuery);
                        const savedRecipes = savedRecipesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderRecipes(profileSavedRecipes, savedRecipes);
                    } else {
                        profileSavedRecipes.innerHTML = `<p class="text-gray-500">No recipes saved yet.</p>`;
                    }

                    // Listen to user's meal plan recipes (live updates)
                    const mealPlanCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'mealPlans');
                    onSnapshot(mealPlanCollectionRef, async (snapshot) => {
                        const mealPlanItems = [];
                        for (const docSnapshot of snapshot.docs) {
                            const mealPlanData = docSnapshot.data();
                            if (mealPlanData.recipeId) {
                                const recipeDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/recipes`, mealPlanData.recipeId));
                                if (recipeDoc.exists()) {
                                    mealPlanItems.push({ id: docSnapshot.id, ...recipeDoc.data(), mealPlanEntryId: docSnapshot.id });
                                }
                            }
                        }
                        renderMealPlanItems(profileMealPlan, mealPlanItems);
                    }, (error) => {
                        console.error("Error fetching meal plan:", error);
                        profileMealPlan.innerHTML = `<p class="text-red-500">Failed to load meal plan.</p>`;
                    });

                } else {
                    console.log("User profile document does not exist for current user. It might be created during signup/login.");
                }
            }, (error) => {
                console.error("Error fetching user profile:", error);
                showModalMessage("Failed to load your profile data.", null);
            });
        }


        // --- Event Listeners ---

        // Global Navigation
        homeLink.addEventListener('click', (e) => { e.preventDefault(); showPage(homePage); });
        addRecipeNavBtn.addEventListener('click', () => {
            if (!currentUserId) { showModalMessage("Please sign in to add a recipe.", null); return; }
            resetAddEditForm(); showPage(addRecipePage);
        });
        profileNavBtn.addEventListener('click', () => {
            if (!currentUserId) { showModalMessage("Please sign in to view your profile.", null); return; }
            showPage(profilePage);
        });
        loginNavBtn.addEventListener('click', () => { showPage(loginPage); });
        signupNavBtn.addEventListener('click', () => { showPage(signupPage); });
        logoutBtn.addEventListener('click', async () => {
            try { 
                await signOut(auth); 
                showModalMessage("You have been logged out.", () => { 
                    // After logging out, ensure the UI reflects the logged-out state.
                    // The onAuthStateChanged listener will handle the anonymous sign-in and page redirect.
                    // No need for explicit showPage(homePage) here as onAuthStateChanged handles it.
                }); 
            }
            catch (error) { 
                console.error("Error during logout:", error); 
                showModalMessage("Failed to log out. Please try again.", null); 
            }
        });

        // Mobile Navigation
        homeLinkMobile.addEventListener('click', (e) => { e.preventDefault(); showPage(homePage); });
        addRecipeNavBtnMobile.addEventListener('click', () => {
            if (!currentUserId) { showModalMessage("Please sign in to add a recipe.", null); return; }
            resetAddEditForm(); showPage(addRecipePage);
        });
        profileNavBtnMobile.addEventListener('click', () => {
            if (!currentUserId) { showModalMessage("Please sign in to view your profile.", null); return; }
            showPage(profilePage);
        });
        loginNavBtnMobile.addEventListener('click', () => showPage(loginPage));
        signupNavBtnMobile.addEventListener('click', () => showPage(signupPage));
        logoutBtnMobile.addEventListener('click', async () => {
            try { 
                await signOut(auth); 
                showModalMessage("You have been logged out.", () => { 
                    // Same as desktop logout: onAuthStateChanged handles the follow-up
                }); 
            }
            catch (error) { 
                console.error("Error during mobile logout:", error); 
                showModalMessage("Failed to log out. Please try again.", null); 
            }
        });

        // Login/Signup Page Navigation
        switchToSignupLink.addEventListener('click', (e) => { e.preventDefault(); showPage(signupPage); });
        switchToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showPage(loginPage); });

        // Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!email || !password) { loginMessage.textContent = 'Please enter both email and password.'; loginMessage.className = 'mt-4 text-center text-sm font-medium text-red-600'; return; }
            loginMessage.textContent = 'Logging in...'; loginMessage.className = 'mt-4 text-center text-sm font-medium text-blue-600';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginMessage.textContent = 'Login successful!'; loginMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';
                loginForm.reset();
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') { errorMessage = "Invalid email or password."; }
                else if (error.code === 'auth/invalid-email') { errorMessage = "Invalid email format."; }
                loginMessage.textContent = errorMessage; loginMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
            }
        });

        // Sign Up Form Submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value.trim();
            const confirmPassword = signupConfirmPasswordInput.value.trim();
            if (!email || !password || !confirmPassword) { signupMessage.textContent = 'Please fill in all fields.'; signupMessage.className = 'mt-4 text-center text-sm font-medium text-red-600'; return; }
            if (password.length < 6) { signupMessage.textContent = 'Password must be at least 6 characters long.'; signupMessage.className = 'mt-4 text-center text-sm font-medium text-red-600'; return; }
            if (password !== confirmPassword) { signupMessage.textContent = 'Passwords do not match.'; signupMessage.className = 'mt-4 text-center text-sm font-medium text-red-600'; return; }
            signupMessage.textContent = 'Signing up...'; signupMessage.className = 'mt-4 text-center text-sm font-medium text-blue-600';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Create user profile in Firestore immediately after successful signup
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                await setDoc(userProfileDocRef, {
                    displayName: `User_${user.uid.substring(0, 6)}`,
                    email: user.email,
                    bio: 'A passionate home cook.',
                    profileImageUrl: getPlaceholderImage('Avatar'), // Default avatar
                    likedRecipes: [],
                    favoritedRecipes: [],
                    savedRecipes: [],
                    createdAt: new Date().toISOString()
                });
                signupMessage.textContent = 'Sign up successful! Redirecting...'; signupMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';
                signupForm.reset();
            } catch (error) {
                console.error("Sign up error:", error);
                let errorMessage = "Sign up failed. Please try again.";
                if (error.code === 'auth/email-already-in-use') { errorMessage = "This email is already in use."; }
                else if (error.code === 'auth/invalid-email') { errorMessage = "Invalid email format."; }
                else if (error.code === 'auth/weak-password') { errorMessage = "Password is too weak. Must be at least 6 characters."; }
                signupMessage.textContent = errorMessage; signupMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
            }
        });

        // Back to Home Button on Detail Page
        backToHomeBtn.addEventListener('click', () => { showPage(homePage); });

        // Add/Edit Recipe Functionality
        addRecipeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showModalMessage("You must be signed in to add/edit a recipe.", null); return; }

            const title = recipeTitleInput.value.trim();
            const description = recipeDescriptionInput.value.trim();
            // Ingredients and instructions are already handled as arrays on input, which is correct for Firestore.
            const ingredients = recipeIngredientsInput.value.split('\n').map(item => item.trim()).filter(item => item !== '');
            const instructions = recipeInstructionsInput.value.split('\n').map(item => item.trim()).filter(item => item !== '');
            const categories = recipeCategoriesInput.value.split(',').map(item => item.trim()).filter(item => item !== '');
            const imageUrl = recipeImageUrlInput.value.trim();

            if (!title || !description || ingredients.length === 0 || instructions.length === 0) {
                showModalMessage("Please fill in all required fields (Title, Description, Ingredients, Instructions).", null); return; }

            addRecipeMessage.textContent = editingRecipeId ? 'Updating recipe...' : 'Adding recipe...';
            addRecipeMessage.className = 'mt-4 text-center text-sm font-medium text-blue-600';

            try {
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userProfileDocSnap = await getDoc(userProfileDocRef);
                const userData = userProfileDocSnap.exists() ? userProfileDocSnap.data() : {};
                const userName = userData.displayName || 'Anonymous';
                const authorAvatarUrl = userData.profileImageUrl || getPlaceholderImage('User');

                const recipeData = {
                    title, description, ingredients, instructions, categories,
                    imageUrl: imageUrl || getPlaceholderImage(title),
                    userId: currentUserId, userName: userName, authorAvatarUrl: authorAvatarUrl,
                    ...(editingRecipeId ? {} : { likesCount: 0, favoritesCount: 0, savesCount: 0, averageRating: 0, numReviews: 0, timestamp: new Date().toISOString() })
                };

                if (editingRecipeId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/recipes`, editingRecipeId), recipeData);
                    addRecipeMessage.textContent = 'Recipe updated successfully!';
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/recipes`), recipeData);
                    addRecipeMessage.textContent = 'Recipe added successfully!';
                }
                addRecipeMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';
                resetAddEditForm();
                setTimeout(() => { addRecipeMessage.textContent = ''; showPage(homePage); }, 1500);
            } catch (error) {
                console.error("Error adding/updating recipe:", error);
                addRecipeMessage.textContent = `Failed to ${editingRecipeId ? 'update' : 'add'} recipe. Please try again.`;
                addRecipeMessage.className = 'mt-4 text-center text-sm font-medium text-red-600';
            }
        });

        /**
         * Loads an existing recipe into the add/edit form for editing.
         * @param {string} recipeId The ID of the recipe to load.
         */
        async function loadRecipeForEdit(recipeId) {
            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, recipeId);
                const recipeDocSnap = await getDoc(recipeDocRef);

                if (recipeDocSnap.exists()) {
                    const recipeData = recipeDocSnap.data();
                    editingRecipeId = recipeId;
                    addEditRecipeTitle.textContent = 'Edit Your Recipe';
                    submitRecipeBtn.textContent = 'Update Recipe';

                    recipeTitleInput.value = recipeData.title || '';
                    recipeDescriptionInput.value = recipeData.description || '';
                    // Convert array back to newline-separated string for textarea display
                    recipeIngredientsInput.value = (Array.isArray(recipeData.ingredients) ? recipeData.ingredients.join('\n') : recipeData.ingredients || '');
                    recipeInstructionsInput.value = (Array.isArray(recipeData.instructions) ? recipeData.instructions.join('\n') : recipeData.instructions || '');
                    recipeCategoriesInput.value = (Array.isArray(recipeData.categories) ? recipeData.categories.join(', ') : recipeData.categories || '');
                    recipeImageUrlInput.value = recipeData.imageUrl || '';

                    showPage(addRecipePage);
                } else {
                    showModalMessage("Recipe not found for editing.", null);
                }
            } catch (error) {
                console.error("Error loading recipe for edit:", error);
                showModalMessage("Failed to load recipe for editing. Please try again.", null);
            }
        }


        // Gemini API Integration for Description Generation
        generateDescriptionBtn.addEventListener('click', async () => {
            const recipeTitle = recipeTitleInput.value.trim();
            if (!recipeTitle) { showModalMessage("Please enter a recipe title before generating a description.", null); return; }
            descriptionLoadingSpinner.classList.remove('hidden'); generateDescriptionBtn.disabled = true; recipeDescriptionInput.value = 'Generating description...';
            try {
                let chatHistory = [];
                const prompt = `Generate a concise and appealing description for a recipe titled "${recipeTitle}". Focus on taste, texture, and what makes it special. Keep it under 100 words.`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    recipeDescriptionInput.value = generatedText;
                } else { recipeDescriptionInput.value = 'Failed to generate description. Please try again.'; console.error("Gemini API response structure unexpected:", result); }
            } catch (error) { console.error("Error calling Gemini API:", error); recipeDescriptionInput.value = 'Error generating description. Check console for details.'; }
            finally { descriptionLoadingSpinner.classList.add('hidden'); generateDescriptionBtn.disabled = false; }
        });

        // Ingredient Scaling
        scaleIngredientsBtn.addEventListener('click', () => {
            const targetServings = parseInt(servingsInput.value);
            if (isNaN(targetServings) || targetServings <= 0) { showModalMessage("Please enter a valid number of servings (greater than 0).", null); return; }
            if (!originalIngredients || originalIngredients.length === 0) { showModalMessage("No ingredients to scale.", null); return; }
            const scaled = originalIngredients.map(item => {
                const match = item.match(/^(\d+(\.\d+)?(\/\d+)?)\s*(.*)/);
                if (match) {
                    let quantity = parseFloat(match[1]);
                    if (match[1].includes('/')) { const parts = match[1].split('/'); quantity = parseFloat(parts[0]) / parseFloat(parts[1]); }
                    const unitAndItem = match[4]; const newQuantity = quantity * targetServings;
                    return `${newQuantity.toFixed(2).replace(/\.00$/, '')} ${unitAndItem}`;
                }
                return item + ` (scaled for ${targetServings} servings)`;
            });
            renderIngredients(scaled);
            showModalMessage(`Ingredients scaled for ${targetServings} servings. Note: Complex ingredient strings may not scale accurately.`, null);
        });

        // Recipe Interaction (Like, Favorite, Save)
        likeBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentRecipeId) { showModalMessage("Please sign in to like recipes.", null); return; }
            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, currentRecipeId);
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userDocSnap = await getDoc(userProfileDocRef);
                const userData = userDocSnap.data();
                const likedRecipes = userData.likedRecipes || [];
                let newLikesCount = currentRecipeData.likesCount || 0; // Get current count from loaded data

                if (likedRecipes.includes(currentRecipeId)) {
                    await updateDoc(recipeDocRef, { likesCount: newLikesCount - 1 });
                    await updateDoc(userProfileDocRef, { likedRecipes: arrayRemove(currentRecipeId) });
                } else {
                    await updateDoc(recipeDocRef, { likesCount: newLikesCount + 1 });
                    await updateDoc(userProfileDocRef, { likedRecipes: arrayUnion(currentRecipeId) });
                }
            } catch (error) { console.error("Error toggling like:", error); showModalMessage("Failed to update like status. Please try again.", null); }
        });

        favoriteBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentRecipeId) { showModalMessage("Please sign in to favorite recipes.", null); return; }
            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, currentRecipeId);
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userDocSnap = await getDoc(userProfileDocRef);
                const userData = userDocSnap.data();
                const favoritedRecipes = userData.favoritedRecipes || [];
                let newFavoritesCount = currentRecipeData.favoritesCount || 0;

                if (favoritedRecipes.includes(currentRecipeId)) {
                    await updateDoc(recipeDocRef, { favoritesCount: newFavoritesCount - 1 });
                    await updateDoc(userProfileDocRef, { favoritedRecipes: arrayRemove(currentRecipeId) });
                } else {
                    await updateDoc(recipeDocRef, { favoritesCount: newFavoritesCount + 1 });
                    await updateDoc(userProfileDocRef, { favoritedRecipes: arrayUnion(currentRecipeId) });
                }
            } catch (error) { console.error("Error toggling favorite:", error); showModalMessage("Failed to update favorite status. Please try again.", null); }
        });

        saveBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentRecipeId) { showModalMessage("Please sign in to save recipes.", null); return; }
            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, currentRecipeId);
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userDocSnap = await getDoc(userProfileDocRef);
                const userData = userDocSnap.data();
                const savedRecipes = userData.savedRecipes || [];
                let newSavesCount = currentRecipeData.savesCount || 0;

                if (savedRecipes.includes(currentRecipeId)) {
                    await updateDoc(recipeDocRef, { savesCount: newSavesCount - 1 });
                    await updateDoc(userProfileDocRef, { savedRecipes: arrayRemove(currentRecipeId) });
                } else {
                    await updateDoc(userProfileDocRef, { savesCount: newSavesCount + 1 });
                    await updateDoc(userProfileDocRef, { savedRecipes: arrayUnion(currentRecipeId) });
                }
            } catch (error) { console.error("Error toggling save:", error); showModalMessage("Failed to update save status. Please try again.", null); }
        });

        // Share Recipe
        shareBtn.addEventListener('click', () => {
            if (!currentRecipeId) { showModalMessage("No recipe selected to share.", null); return; }
            const recipeUrl = `${window.location.origin}${window.location.pathname}#recipe=${currentRecipeId}`;
            // Use document.execCommand('copy') for better compatibility in iframe environments
            document.execCommand('copy'); 
            showModalMessage("Recipe link copied to clipboard!", null);
        });

        // Add to Meal Plan
        addToMealPlanBtn.addEventListener('click', async () => {
            if (!currentUserId || !currentRecipeId || !currentRecipeData) { showModalMessage("Please sign in to add recipes to your meal plan.", null); return; }
            try {
                const mealPlanQuery = query(collection(db, 'artifacts', appId, 'users', currentUserId, 'mealPlans'), where("recipeId", "==", currentRecipeId));
                const querySnapshot = await getDocs(mealPlanQuery);
                if (!querySnapshot.empty) { showModalMessage("This recipe is already in your meal plan!", null); return; }
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUserId, 'mealPlans'), {
                    recipeId: currentRecipeId, title: currentRecipeData.title,
                    imageUrl: currentRecipeData.imageUrl || getPlaceholderImage(currentRecipeData.title),
                    timestamp: new Date().toISOString()
                });
                showModalMessage("Recipe added to your meal plan!", null);
            }
            catch (error) { console.error("Error adding to meal plan:", error); showModalMessage("Failed to add recipe to meal plan. Please try again.", null); }
        });

        // Print Recipe
        printRecipeBtn.addEventListener('click', () => {
            const header = document.querySelector('header'); const mainContent = document.querySelector('main');
            const backButton = document.getElementById('back-to-home-btn'); const actionButtons = document.querySelector('#recipe-detail-content > .flex.items-center.justify-center');
            const reviewSection = document.querySelector('#recipe-detail-page .mt-12');
            if (header) header.style.display = 'none'; if (backButton) backButton.style.display = 'none';
            if (actionButtons) actionButtons.style.display = 'none'; if (reviewSection) reviewSection.style.display = 'none';
            if (mainContent) mainContent.style.padding = '0';
            window.print();
            if (header) header.style.display = ''; if (backButton) backButton.style.display = '';
            if (actionButtons) actionButtons.style.display = 'flex'; if (reviewSection) reviewSection.style.display = 'block';
            if (mainContent) mainContent.style.padding = '';
        });

        // Delete Recipe (from profile)
        async function deleteRecipe(recipeId) {
            if (!currentUserId) { showModalMessage("You must be signed in to delete recipes.", null); return; }
            try {
                const recipeDocRef = doc(db, `artifacts/${appId}/public/data/recipes`, recipeId);
                const recipeDocSnap = await getDoc(recipeDocRef);
                if (recipeDocSnap.exists() && recipeDocSnap.data().userId === currentUserId) {
                    await deleteDoc(recipeDocRef);
                    showModalMessage("Recipe deleted successfully!", null);
                } else { showModalMessage("You can only delete your own recipes.", null); }
            } catch (error) { console.error("Error deleting recipe:", error); showModalMessage("Failed to delete recipe. Please try again.", null); }
        });

        // Profile Page Functionality
        updateProfileBtn.addEventListener('click', async () => {
            if (!currentUserId) { showModalMessage("Please sign in to update your profile.", null); return; }
            profileMessage.textContent = 'Updating profile...'; profileMessage.className = 'mt-4 text-center text-sm font-medium text-blue-600';
            const newDisplayName = profileDisplayNameInput.value.trim();
            const newBio = profileBioInput.value.trim();
            const newProfileImageUrl = profileImageUrlInput.value.trim();
            try {
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                await updateDoc(userProfileDocRef, {
                    displayName: newDisplayName, bio: newBio,
                    profileImageUrl: newProfileImageUrl || getPlaceholderImage('Avatar')
                });
                profileMessage.textContent = 'Profile updated successfully!'; profileMessage.className = 'mt-4 text-center text-sm font-medium text-green-600';
            } catch (error) { console.error("Error updating profile:", error); profileMessage.textContent = 'Failed to update profile. Please try again.'; profileMessage.className = 'mt-4 text-center text-sm font-medium text-red-600'; }
        });

        // Review System Functions
        userRatingStars.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('fa-star')) {
                const hoveredRating = parseInt(e.target.dataset.rating);
                const stars = userRatingStars.querySelectorAll('.fa-star');
                stars.forEach((star, index) => {
                    if (index < hoveredRating) { star.classList.add('fas', 'active'); star.classList.remove('far'); }
                    else { star.classList.add('far'); star.classList.remove('fas', 'active'); }
                });
            }
        });
        userRatingStars.addEventListener('mouseout', () => { const currentSelectedRating = parseInt(selectedRatingInput.value); setStarRatingDisplay(userRatingStars, currentSelectedRating); });
        userRatingStars.addEventListener('click', (e) => {
            if (e.target.classList.contains('fa-star')) {
                const clickedRating = parseInt(e.target.dataset.rating);
                selectedRatingInput.value = clickedRating;
                setStarRatingDisplay(userRatingStars, clickedRating);
            }
        });

        reviewForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId || !currentRecipeId) { showModalMessage("Please sign in to submit a review.", null); return; }
            const rating = parseInt(selectedRatingInput.value);
            const reviewText = reviewTextInput.value.trim();
            if (rating === 0) { reviewMessage.textContent = 'Please select a star rating.'; reviewMessage.className = 'mt-2 text-center text-sm font-medium text-red-600'; return; }
            reviewMessage.textContent = 'Submitting review...'; reviewMessage.className = 'mt-2 text-center text-sm font-medium text-blue-600';
            try {
                const existingReviewQuery = query(collection(db, `artifacts/${appId}/public/data/recipes/${currentRecipeId}/reviews`), where("userId", "==", currentUserId));
                const existingReviewSnapshot = await getDocs(existingReviewQuery);
                // User profile document is now directly at artifacts/{appId}/users/{userId}
                const userProfileDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userProfileSnap = await getDoc(userProfileDocRef);
                const profileData = userProfileSnap.exists() ? userProfileSnap.data() : {};
                const reviewData = {
                    userId: currentUserId, userName: profileData.displayName || `User_${currentUserId.substring(0, 6)}`,
                    userAvatarUrl: profileData.profileImageUrl || getPlaceholderImage('User'), rating: rating,
                    reviewText: reviewText, timestamp: new Date().toISOString()
                };
                if (!existingReviewSnapshot.empty) {
                    const reviewDocRef = existingReviewSnapshot.docs[0].ref;
                    await updateDoc(reviewDocRef, reviewData);
                    reviewMessage.textContent = 'Review updated successfully!';
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/recipes/${currentRecipeId}/reviews`), reviewData);
                    reviewMessage.textContent = 'Review submitted successfully!';
                }
                reviewMessage.className = 'mt-2 text-center text-sm font-medium text-green-600';
                reviewForm.reset(); selectedRatingInput.value = '0'; resetStarSelection(userRatingStars);
                await calculateAverageRating(currentRecipeId);
            } catch (error) { console.error("Error submitting review:", error); reviewMessage.textContent = 'Failed to submit review. Please try again.'; reviewMessage.className = 'mt-2 text-center text-sm font-medium text-red-600'; }
        });

        // Search and Filter Functionality
        searchInput.addEventListener('input', filterAndRenderRecipes);
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; clearSearchBtn.classList.add('hidden'); filterAndRenderRecipes(); });
        searchInputMobile.addEventListener('input', filterAndRenderRecipes);
        clearSearchBtnMobile.addEventListener('click', () => { searchInputMobile.value = ''; clearSearchBtnMobile.classList.add('hidden'); filterAndRenderRecipes(); });

        categoryFilterButtons.forEach(button => {
            button.addEventListener('click', () => {
                categoryFilterButtons.forEach(btn => btn.classList.remove('bg-red-500', 'text-white'));
                button.classList.add('bg-red-500', 'text-white');
                currentCategoryFilter = button.dataset.category;
                filterAndRenderRecipes();
            });
        });
        // Set initial active state for "All" button
        document.querySelector('.category-filter-btn[data-category="All"]').classList.add('bg-red-500', 'text-white');

        // Dark Mode Toggle
        function applyTheme(isDarkMode) {
            if (isDarkMode) { document.body.classList.add('dark-mode'); themeIcon.classList.replace('fa-moon', 'fa-sun'); themeIconMobile.classList.replace('fa-moon', 'fa-sun'); }
            else { document.body.classList.remove('dark-mode'); themeIcon.classList.replace('fa-sun', 'fa-moon'); themeIconMobile.classList.replace('fa-sun', 'fa-moon'); }
        }
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') { applyTheme(true); } else { applyTheme(false); }
        themeToggleBtn.addEventListener('click', () => { const isDarkMode = document.body.classList.contains('dark-mode'); applyTheme(!isDarkMode); localStorage.setItem('theme', !isDarkMode ? 'dark' : 'light'); });
        themeToggleBtnMobile.addEventListener('click', () => { const isDarkMode = document.body.classList.contains('dark-mode'); applyTheme(!isDarkMode); localStorage.setItem('theme', !isDarkMode ? 'dark' : 'light'); });

        // Mobile Menu Toggle
        hamburgerMenuBtn.addEventListener('click', () => { mobileMenu.classList.remove('hidden'); setTimeout(() => { mobileMenu.classList.add('open'); document.body.style.overflow = 'hidden'; }, 10); });
        mobileMenuCloseBtn.addEventListener('click', () => { mobileMenu.classList.remove('open'); document.body.style.overflow = ''; setTimeout(() => { mobileMenu.classList.add('hidden'); }, 300); });
        searchMobileBtn.addEventListener('click', () => {
            if (homePage.classList.contains('hidden')) { showPage(homePage); }
            searchInputMobile.focus();
            searchInputMobile.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        // --- Initial Load / Deep Linking ---
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#recipe=')) {
                initialRecipeIdFromHash = hash.substring('#recipe='.length);
                console.log("Initial recipe ID from hash:", initialRecipeIdFromHash);
            }
            // onAuthStateChanged listener handles the initial page display and deep linking.
            console.log("App ID:", appId); // Log the app ID for debugging purposes
        });
    </script>
</body>
</html>

